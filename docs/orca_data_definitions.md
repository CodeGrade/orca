# Data Definitions - Orca/Grading VMs

This document explores the shape of data exchanged between various points in the Orca workflow, where JSON objects are passed:

1. From Bottlenose to the Orca Web Server
2. From the Orca Web Server to the Redis Grading Queue
3. From the Redis Grading Queue to the Orca Grading VM
4. From the Orca VM to Bottlenose

## `GradingJob`

<hr>

A `GradingJob` is a JSON object containing details about how to grade a submission following this basic data structure:

```typescript
interface GradingJob {
  submission_id: number;
  grade_id: number;
  grader_id: number;
  course_id: number;
  fixture_code?: CodeFileInfo;
  target_code: CodeFileInfo;
  test_code?: CodeFileInfo;
  priority: integer;
  script: [GradingScriptCommand];
  team_id?: number;
  user_id?: number;
  user_names?: [string];
  submitter_name: string;
}
```

`GradingJob`s require a Grade Id and Submission Id (pulled from Bottlenose), as well as student code to be autograded as a `CodeFileInfo` structure. These are mapped to the `grade_id`, `submission_id`, and `target_code` keys, respectively.

<hr>

### `CodeFileInfo`

A `CodeFileInfo` contains the URL to the file containing submission code, as well as the MIME type of the file.

```typescript
interface CodeFileInfo {
  url: string;
  mime_type: string;
}
```

<hr>

Starter code and/or professor code may also be provided by Bottlenose also as `CodeFileInfo` objects.

Grading jobs have a priority `int`, which is a _delay_ (determined by Bottlenose) to be placed on the job when added to the queue. The object must also have a grading script as an array of `GradingScriptCommand` objects.

<hr>

### `GradingScriptCommand`

A `GradingScriptCommand` is an interface that defines an execution step during the autograding process. It takes one of the following shapes:

```typescript
interface BashGradingScriptCommand {
  cmd: string;
  on_fail: 'abort' | number;
  on_complete: 'output' | number;
}
```

A `BashGradingScriptCommand` describes a step in the grading script that requires interaction with the shell. This can be compilation, running grader tests, etc. The `cmd` key points to the bash command to run.

The `on_fail` value is either `"abort"` or a number >= 0 that maps to another command in the list. When executing the script, if the command fails it will either exit the script if `on_fail` is set to `"abort"` or go to the command at the specified index.

The `on_complete` key serves a similar purpose to `on_fail`, but instead we exit the script (successfully) on the string `"output"`. Otherwise, we navigate to the given index.

```typescript
interface GradingScriptCondition {
  predicate: 'exists' | 'file' | 'dir';
  path: string;
}

interface ConditionalGradingScriptCommand {
  condition: GradingScriptCondition;
  on_true: number;
  on_false: number;
}
```

A `ConditionalGradingScriptCommand` is, in essence, an _if-else_ statement implementation that dictates the flow of the script based on the file system.

The `GradingScriptCondition` defines how to check for the existence of an object in the file path: either as a file (`'file'`), a directory (`'dir'`), or as either one (`'exists'`). This existence query will decide which command to move onto next, specified by keys `on_true` and `on_false`.

<hr>

This array represents a graph of commands -- where the on\_\* keys are edges to the next command. These scripts will be auto-generated on the Bottlenose side as **Directed Acyclic Graphs** (DAG). Using a DAG ensures execution will not enter an infinite loop of retrying a subset of commands, which would otherwise require more computations to prevent.

Finally, a `GradingJob` may specify either a `team_id`, `student_id`, or neither. This is based on whether the job was submitted by a team, individual student, or a professor, respectively.

## `GradingJobOutput`

Execution of a grading job will result in a `GradingJobOutput` object to send back data to Bottlenose.

```typescript
interface GradingScriptCommandResponse {
  stdout: string;
  stderr: string;
  status_code?: int;
  timed_out: boolean;
  cmd: string;
}

interface GradingJobOutput {
  tap_output?: string;
  shell_responses: [GradingScriptCommandResponse];
  errors?: [string];
  grade_id: number;
  submission_id: number;
  user_id?: number;
  team_id?: number;
}
```

The required fields for the output include the grade ID and the submission ID associated with the job, as well as `shell_responses`: an array of `GradingScriptCommandResponse`s. These objects are generated by execution of a `BashGradingScriptCommand` and contain the original command, a boolean denoting whether or not the command timed out, the command's status code (if applicable), and the resulting STDOUT and STDERR content.

`GradingJobOutput`s may also _potentially_ contain:

- `tap_output` : The Test Anything Protocol (TAP) contents from a successful test execution.
- `errors` : An array of execution error messages (i.e., in the VM program) received from executing the grading script.
